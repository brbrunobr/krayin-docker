# Atualize a versão para suportar a condição 'service_healthy'
version: "3.9"

services:
  krayin-php-apache:
    build:
      args:
        container_project_path: /var/www/html/
        uid: 1519
        user: ${USER}
      context: .
      dockerfile: ./Dockerfile
    image: krayin-php-apache
    environment:
      # Configurações de Email IMAP
      IMAP_HOST: ${IMAP_HOST:-imap.gmail.com}
      IMAP_PORT: ${IMAP_PORT:-993}
      IMAP_USERNAME: ${IMAP_USERNAME}
      IMAP_PASSWORD: ${IMAP_PASSWORD}
      IMAP_ENCRYPTION: ${IMAP_ENCRYPTION:-ssl}
      IMAP_VALIDATE_CERT: ${IMAP_VALIDATE_CERT:-true}
    volumes:
      - krayin-storage:/var/www/html/storage
    # Adicione esta seção 'depends_on'
    depends_on:
      krayin-mysql:
        # A condição que faz o serviço esperar
        condition: service_healthy

  krayin-mysql:
    image: mysql:8.0
    command: --default-authentication-plugin=mysql_native_password
    environment:
      MYSQL_ROOT_HOST: "%"
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD}
      # É uma boa prática definir o banco de dados aqui também
      MYSQL_DATABASE: krayin # Substitua 'krayin' pelo nome do seu banco de dados, se for diferente
    volumes:
      - ./.configs/mysql-data:/var/lib/mysql/
    # Adicione esta seção 'healthcheck'
    healthcheck:
      # O comando que o Docker executará para verificar a saúde do MySQL
      test:
        [
          "CMD",
          "mysqladmin",
          "ping",
          "-h",
          "localhost",
          "-u",
          "root",
          "-p${DB_PASSWORD}",
        ]
      interval: 10s # Intervalo entre as verificações
      timeout: 5s # Tempo máximo para a verificação responder
      retries: 10 # Número de tentativas antes de marcar como 'unhealthy'

  krayin-redis:
    image: redis:6.2-alpine
    command: redis-server --save 20 1 --loglevel warning
    volumes:
      - ./.configs/redis-data:/data

  krayin-phpmyadmin:
    image: phpmyadmin:latest
    environment:
      PMA_HOST: krayin-mysql
      PMA_USER: root
      PMA_PASSWORD: ${DB_PASSWORD}
      UPLOAD_LIMIT: 512M
    # Também é uma boa prática fazer o phpMyAdmin esperar pelo banco de dados
    depends_on:
      krayin-mysql:
        condition: service_healthy

  krayin-mailhog:
    image: mailhog/mailhog
    logging:
      driver: "none"

# Adicione esta seção no final para definir o volume nomeado
volumes:
  krayin-storage:
