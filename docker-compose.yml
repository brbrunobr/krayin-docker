# Atualize a vers√£o para suportar a condi√ß√£o 'service_healthy'
version: "3.9"

services:
  krayin-php-apache:
    container_name: krayin-php-apache-${CLIENTE}
    build:
      args:
        container_project_path: /var/www/html/
        uid: 1519
        user: ${USER}
      context: .
      dockerfile: ./Dockerfile
    image: krayin-php-apache-${CLIENTE}
    volumes:
      - krayin-storage-${CLIENTE}:/var/www/html/storage
    # Adicione esta se√ß√£o 'depends_on'
    depends_on:
      krayin-mysql:
        # A condi√ß√£o que faz o servi√ßo esperar
        condition: service_healthy
    environment:
      # üß© Configura√ß√µes principais da aplica√ß√£o
      APP_NAME: ${APP_NAME}
      APP_URL: ${APP_URL}
      APP_KEY: ${APP_KEY}
      APP_CURRENCY: ${APP_CURRENCY}
      ASSET_URL: ${ASSET_URL}
      APP_ENV: production
      APP_DEBUG: false

      # üì¶ Banco de Dados
      DB_CONNECTION: ${DB_CONNECTION}
      DB_HOST: ${DB_HOST}
      DB_PORT: ${DB_PORT}
      DB_DATABASE: ${DB_DATABASE}
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}

      # üß† Redis (Cache e Sess√£o)
      CACHE_DRIVER: redis
      SESSION_DRIVER: redis
      QUEUE_CONNECTION: sync
      REDIS_HOST: krayin-redis

      # üåê Sess√£o / Seguran√ßa
      SANCTUM_STATEFUL_DOMAINS: ${SANCTUM_STATEFUL_DOMAINS}
      SESSION_SECURE_COOKIE: ${SESSION_SECURE_COOKIE}

      # ‚úâÔ∏è Configura√ß√µes de E-mail (SMTP)
      MAIL_MAILER: ${MAIL_MAILER}
      MAIL_HOST: ${MAIL_HOST}
      MAIL_PORT: ${MAIL_PORT}
      MAIL_USERNAME: ${MAIL_USERNAME}
      MAIL_PASSWORD: ${MAIL_PASSWORD}
      MAIL_ENCRYPTION: ${MAIL_ENCRYPTION}
      MAIL_FROM_ADDRESS: ${MAIL_FROM_ADDRESS}
      MAIL_FROM_NAME: ${MAIL_FROM_NAME}
      MAIL_REPLY_TO_ADDRESS: ${MAIL_REPLY_TO_ADDRESS:-${MAIL_FROM_ADDRESS}}
      MAIL_REPLY_TO_NAME: ${MAIL_REPLY_TO_NAME:-${MAIL_FROM_NAME}}
    networks:
      - krayin-network # Rede interna para falar com o DB/Redis
      - proxy-public-network # ### ALTERA√á√ÉO ### Rede p√∫blica para o proxy

  krayin-mysql:
    container_name: krayin-mysql-${CLIENTE}
    image: mysql:8.0
    command: --default-authentication-plugin=mysql_native_password
    environment:
      MYSQL_ROOT_HOST: "%"
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD}
      MYSQL_DATABASE: ${DB_DATABASE}
      MYSQL_USER: ${DB_USERNAME}
      MYSQL_PASSWORD: ${DB_PASSWORD}
    volumes:
      - ./.configs/mysql-data:/var/lib/mysql/
    # Adicione esta se√ß√£o 'healthcheck'
    healthcheck:
      # O comando que o Docker executar√° para verificar a sa√∫de do MySQL
      test:
        [
          "CMD",
          "mysqladmin",
          "ping",
          "-h",
          "localhost",
          "-u",
          "${DB_USERNAME}",
          "-p${DB_PASSWORD}",
        ]
      interval: 10s # Intervalo entre as verifica√ß√µes
      timeout: 5s # Tempo m√°ximo para a verifica√ß√£o responder
      retries: 10 # N√∫mero de tentativas antes de marcar como 'unhealthy'
    networks:
      - krayin-network # Correto: Apenas na rede interna, totalmente isolado.

  krayin-redis:
    container_name: krayin-redis-${CLIENTE}
    image: redis:6.2-alpine
    command: redis-server --save 20 1 --loglevel warning
    volumes:
      - ./.configs/redis-data:/data
    networks:
      - krayin-network # Correto: Apenas na rede interna, totalmente isolado.

  krayin-phpmyadmin:
    container_name: krayin-phpmyadmin-${CLIENTE}
    image: phpmyadmin:latest
    environment:
      PMA_HOST: krayin-mysql
      PMA_USER: ${DB_USERNAME}
      PMA_PASSWORD: ${DB_PASSWORD}
      UPLOAD_LIMIT: 512M
    # Tamb√©m √© uma boa pr√°tica fazer o phpMyAdmin esperar pelo banco de dados
    depends_on:
      krayin-mysql:
        condition: service_healthy
    networks:
      - krayin-network # Rede interna para falar com o DB
      - proxy-public-network # ### ALTERA√á√ÉO ### Rede p√∫blica para o proxy

  krayin-mailhog:
    container_name: krayin-mailhog-${CLIENTE}
    image: mailhog/mailhog
    logging:
      driver: "none"
    networks:
      - krayin-network # Rede interna para o app enviar e-mails
      - proxy-public-network # ### ALTERA√á√ÉO ### Rede p√∫blica para voc√™ acessar a UI

# Adicione esta se√ß√£o no final para definir o volume nomeado
volumes:
  krayin-storage-${CLIENTE}:
    name: krayin-storage-${CLIENTE}

# Se√ß√£o para definir as redes
networks:
  krayin-network:
    # ### ALTERA√á√ÉO ### Mudamos para external: true para consist√™ncia
    external: true
    name: krayin-network-${CLIENTE}

  proxy-public-network: # ### ALTERA√á√ÉO ### Declaramos a rede do proxy
    external: true
